# Гайд по разработке проекта 

## Разделение пакетов

### Примерная файловая структура репозитория

```
- cmd
| - app
| | - main.go
- docs
| - arch.png
| - swagger.json
- internal
| - app
| | - app.go
| - models/domain
| - interfaces
| - service
| - transport
| | - http_transport
| | - grpc_transport
```

### Описание ролей пакетов

1. ```cmd/app``` - хранит ```main``` функцию, которая запускает приложение
2. ```docs/``` - хранит схему архитектуры и swagger документацию
3. ```internal/app``` - хранит функцию, в которой происходит инициализация сервиса, 
инициализируются все нужные структуры и запускается приложение на указанном порту
4. ```internal/models```, либо ```internal/domain``` - хранит информацию о структурах, 
которые используется между пакетами(т.е. выходят за рамки одного пакета)
5. ```internal/interfaces``` - хранит внутри пакеты с реализацией
интеграций к различным системам (например, пакет ```pq``` для работы с базой или ```gateway```
для работы со шлюзом). Каждый пакет должен содержать **минимум** логики, либо не содержать вообще.
6. ```internal/service``` - пакет, в котором реализована бизнес логика и вызываются интерфейсы из
пакетов, описанных в ```internal/repo```
7. ```internal/transport``` - пакет, в котором описан роутинг запрос, необходимые 
middleware и валидация запросов. После обработки запросов, вызывается метод из сервиса
бизнес логики (суффикс ```_transport``` в конце нужна, чтобы не было совпадения с пакетами языка)

_Важно:_

_Каждый пакет должен быть изолирован от другого. Пакеты, которые находятся внизу по 
стеку вызова, не должны знать о структурах из пакетов выше по стеку вызовов_

### Импорты и зависимости

Для удобства тестирования и отчуждаемости пакетов, необходимо подключать каждый элемент, 
как интерфейс. Рассмотрим на примере:

```go
// internal/interfaces/pq/models.go
type Server struct{...}
func (c *Server) Add(){}

// internal/service/models.go
type storable interface {
    Add()
}

type service struct {
	storage storable
	//...
}
```

Интерфейс должен описываться там, где он используется. Т.е., если мы в пакете ```service```
используем БД, то нам необходимо описать соответствующий интерфейс рядом со структурой,
которая должна работать с этим интерфейсом

## Тестирование пакетов


Обязательным является покрытие тестами следующих слоев:
- Слой бизнес-логики (```internal/service```)

[//]: # (- Слой систем хранения &#40;```internal/interfaces/...```&#41;)

Транспортный слой, слой интеграций и доменный может быть не покрыт тестами.

Для написания тестов с подменой интерфейсов необходимо использовать моки.
Библиотека для моков - ```github.com/gojuno/minimock/v3```

### Создание моков

Устанавливаем инструмент
```go install github.com/gojuno/minimock/v3/cmd/minimock@latest```

Генерируем мок для интерфейса
```minimock -i ./internal/service.storable -o ./internal/service```

Здесь ```-i``` путь до интерфейса, который будем мокать, где после точки пишется имя интерфейса.
```-o``` путь до директории, в которой будем размещать сгенерированные файлы.

#### Принцип размещения моков в директориях проекта.

Если сгенерированные моки необходимы только в конкретном пакете, то они должны располагаться
в этом пакете. Если моки нужны для нескольких пакетов, то должны быть подняты "наверх" для импортирования
в нужные пакеты.
